<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Living Apology</title>

<!-- GSAP (Free) -->
<script src="https://unpkg.com/gsap@3/dist/gsap.min.js"></script>

<style>
/* ================= RESET ================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  width: 100%;
  height: 100%;
  background: #000;
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* ================= CANVAS ================= */
canvas {
  position: fixed;
  inset: 0;
}

/* ================= UI ================= */
#hint {
  position: fixed;
  bottom: 14%;
  width: 100%;
  text-align: center;
  color: rgba(255,255,255,0.6);
  font-size: 13px;
  letter-spacing: 2px;
  opacity: 0;
  pointer-events: none;
}

#holdButton {
  position: fixed;
  bottom: 10%;
  left: 50%;
  transform: translateX(-50%);
  padding: 14px 28px;
  border-radius: 40px;
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.85);
  font-size: 14px;
  letter-spacing: 1px;
  backdrop-filter: blur(12px);
  opacity: 0;
  user-select: none;
}
</style>
</head>

<body>

<canvas id="scene"></canvas>
<div id="hint">Tap the screen</div>
<div id="holdButton">Hold to feel it</div>

<script>
/* =====================================================
   LIVING APOLOGY — SINGLE FILE ENGINE
   ===================================================== */

const canvas = document.getElementById("scene");
const ctx = canvas.getContext("2d");

let w, h, dpr = window.devicePixelRatio || 1;

function resize() {
  w = canvas.width = innerWidth * dpr;
  h = canvas.height = innerHeight * dpr;
  canvas.style.width = innerWidth + "px";
  canvas.style.height = innerHeight + "px";
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
resize();
addEventListener("resize", resize);

/* ================= AUDIO (Web Audio API) ================= */

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function heartbeat() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.value = 70;
  gain.gain.value = 0.18;
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.frequency.exponentialRampToValueAtTime(20, audioCtx.currentTime + 0.2);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
  osc.stop(audioCtx.currentTime + 0.4);
}

function breathe() {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.value = 160;
  gain.gain.value = 0.04;
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 2);
  osc.stop(audioCtx.currentTime + 2);
}

/* ================= PARTICLES ================= */

class Particle {
  constructor(x, y, color = "255,220,220") {
    this.x = x;
    this.y = y;
    this.vx = (Math.random() - 0.5) * 0.6;
    this.vy = Math.random() * 0.8;
    this.life = 1;
    this.color = color;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.life -= 0.003;
  }
  draw() {
    ctx.fillStyle = `rgba(${this.color},${this.life})`;
    ctx.fillRect(this.x, this.y, 1.3, 1.3);
  }
}

let particles = [];

/* ================= STATE ================= */

let state = "dark";
let beatCount = 0;
const letters = ["S", "O", "R", "R", "Y"];

/* ================= RENDER LOOP ================= */

function render() {
  ctx.clearRect(0, 0, w, h);

  if (state === "love") {
    const g = ctx.createLinearGradient(0, 0, 0, h);
    g.addColorStop(0, "#24131f");
    g.addColorStop(1, "#ff7b7b");
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, w, h);
  }

  particles.forEach((p, i) => {
    p.update();
    p.draw();
    if (p.life <= 0) particles.splice(i, 1);
  });

  requestAnimationFrame(render);
}
render();

/* ================= SCENE 1 — SORRY ================= */

function sorryHeartbeat() {
  if (beatCount >= letters.length) {
    collapse();
    return;
  }

  heartbeat();

  for (let i = 0; i < 240; i++) {
    particles.push(
      new Particle(
        innerWidth / 2 + (Math.random() - 0.5) * 60,
        innerHeight / 2 + (Math.random() - 0.5) * 25
      )
    );
  }

  beatCount++;
  setTimeout(sorryHeartbeat, 900);
}

/* ================= COLLAPSE ================= */

function collapse() {
  document.getElementById("hint").style.opacity = 1;
  gsap.to(particles, {
    vy: 2.2,
    duration: 2.2,
    ease: "power2.in"
  });
}

/* ================= TAP → REVERSE ================= */

addEventListener("pointerdown", () => {
  if (state !== "dark") return;
  audioCtx.resume();
  document.getElementById("hint").style.opacity = 0;

  gsap.to(particles, {
    vy: -1.4,
    duration: 2,
    ease: "power3.out",
    onComplete: transform
  });
});

/* ================= TRANSFORMATION ================= */

function transform() {
  state = "love";
  breathe();

  gsap.to(document.body, {
    backgroundColor: "#24131f",
    duration: 3
  });

  setTimeout(loveReveal, 1200);
}

/* ================= I LOVE YOU ================= */

function loveReveal() {
  particles.length = 0;

  for (let i = 0; i < 900; i++) {
    particles.push(
      new Particle(
        innerWidth / 2 + Math.sin(i) * 90,
        innerHeight / 2 + Math.cos(i * 0.8) * 35,
        "255,120,120"
      )
    );
  }

  document.getElementById("holdButton").style.opacity = 1;
}

/* ================= HOLD ================= */

let holdTimer;
const holdBtn = document.getElementById("holdButton");

holdBtn.addEventListener("pointerdown", () => {
  holdTimer = setTimeout(() => {
    gsap.to(particles, {
      life: 2,
      duration: 2.5,
      ease: "elastic.out(1,0.4)"
    });
    gsap.to(document.body, {
      backgroundColor: "#ffd6d6",
      duration: 3
    });
  }, 600);
});

holdBtn.addEventListener("pointerup", () => clearTimeout(holdTimer));
holdBtn.addEventListener("pointerleave", () => clearTimeout(holdTimer));

/* ================= START ================= */

setTimeout(sorryHeartbeat, 1200);
</script>

</body>
</html>
